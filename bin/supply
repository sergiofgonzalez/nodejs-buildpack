#!/bin/bash
set -euo pipefail

export PACK_STACK_ID="org.cloudfoundry.stacks.$CF_STACK"

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4
LAUNCH_DIR="$BUILD_DIR/.."
FAKE_LAUNCH_DIR="/home/vcap/deps/$DEPS_IDX"

BP_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

mkdir -p "$FAKE_LAUNCH_DIR"

ln -s "$BUILD_DIR" "$FAKE_LAUNCH_DIR/app"

${BP_DIR}/bin/v3-builder \
-buildpacks "$BP_DIR/cnbs" \
-cache $CACHE_DIR \
-group "$LAUNCH_DIR/group.toml" \
-launch "$FAKE_LAUNCH_DIR" \
-plan "$LAUNCH_DIR/plan.toml" \
-platform "$LAUNCH_DIR"

# TODO : iterate over the buildpacks listed in the order.toml file instead of hand-coding these
mv "$FAKE_LAUNCH_DIR/org.cloudfoundry.buildpacks.nodejs" "$DEPS_DIR/$DEPS_IDX"
mv "$FAKE_LAUNCH_DIR/org.cloudfoundry.buildpacks.npm" "$DEPS_DIR/$DEPS_IDX"
mv "$FAKE_LAUNCH_DIR/config/metadata.toml" "$BUILD_DIR"

rm -rf "$FAKE_LAUNCH_DIR"
